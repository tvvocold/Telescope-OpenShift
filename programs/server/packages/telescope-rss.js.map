{"version":3,"sources":["telescope-rss/lib/server/rss.js","telescope-rss/lib/server/routes.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,6B;;AAEA,6B;AACA,4D;AACA,U;AACA,+B;AACA,uC;AACA,0B;AACA,sB;AACA,yC;AACA,I;AACA,E;;AAEA,oC;AACA,mC;;AAEA,2D;AACA,6C;;AAEA,kE;AACA,gE;AACA,e;AACA,uB;AACA,+E;AACA,yB;AACA,yB;AACA,4B;AACA,mB;AACA,O;AACA,K;;AAEA,oB;AACA,E;;AAEA,8B;AACA,2D;;AAEA,wG;AACA,yC;AACA,e;AACA,qC;AACA,iH;AACA,4B;AACA,4B;AACA,qC;AACA,sB;AACA,O;AACA,K;;AAEA,oB;AACA,E;;;;;;;;;;;;;;;;;;;AClDA,4B;;AAEA,mB;;AAEA,2C;AACA,2D;AACA,0B;AACA,Q;AACA,mB;AACA,qB;AACA,O;;AAEA,mB;;AAEA,oD;AACA,oE;AACA,0B;AACA,Q;AACA,4B;AACA,qB;AACA,O;;AAEA,mB;;AAEA,oD;AACA,oE;AACA,0B;AACA,Q;AACA,4B;AACA,qB;AACA,O;;AAEA,oB;;AAEA,qD;AACA,sE;AACA,0B;AACA,Q;AACA,6B;AACA,qB;AACA,O;;AAEA,kB;;AAEA,kD;AACA,6C;AACA,0B;AACA,Q;AACA,2B;AACA,qB;AACA,O;;AAEA,G","file":"/packages/telescope-rss.js","sourcesContent":["var RSS = Npm.require('rss');\n\nvar getMeta = function(url) {\n  var siteUrl = getSetting('siteUrl', Meteor.absoluteUrl());\n  return {\n    title: getSetting('title'),\n    description: getSetting('tagline'),\n    feed_url: siteUrl+url,\n    site_url: siteUrl,\n    image_url: siteUrl+'img/favicon.png',\n  };\n};\n\nservePostRSS = function(view, url) {\n  var feed = new RSS(getMeta(url));\n\n  var params = getPostsParameters({view: view, limit: 20});\n  delete params['options']['sort']['sticky'];\n\n  Posts.find(params.find, params.options).forEach(function(post) {\n    var description = !!post.body ? post.body+'</br></br>' : '';\n    feed.item({\n     title: post.title,\n     description: description+'<a href=\"'+getPostUrl(post._id)+'\">Discuss</a>',\n     author: post.author,\n     date: post.postedAt,\n     url: getPostLink(post),\n     guid: post._id\n    });\n  });\n\n  return feed.xml();\n};\n\nserveCommentRSS = function() {\n  var feed = new RSS(getMeta(Router.path('rss_comments')));\n\n  Comments.find({isDeleted: {$ne: true}}, {sort: {postedAt: -1}, limit: 20}).forEach(function(comment) {\n    post = Posts.findOne(comment.postId);\n    feed.item({\n     title: 'Comment on '+post.title,\n     description: comment.body+'</br></br>'+'<a href=\"'+getPostCommentUrl(post._id, comment._id)+'\">Discuss</a>',\n     author: comment.author,\n     date: comment.postedAt,\n     url: getCommentUrl(comment._id),\n     guid: comment._id\n    });\n  });\n\n  return feed.xml();\n};\n","Meteor.startup(function () {\n\n    // New Post RSS\n\n    Router.route('/feed.xml', function () {\n      this.response.write(servePostRSS('new', 'feed.xml'));\n      this.response.end();\n    }, {\n      name: 'feed',\n      where: 'server'\n    });\n\n    // New Post RSS\n\n    Router.route('/rss/posts/new.xml', function () {\n      this.response.write(servePostRSS('top', 'rss/posts/new.xml'));\n      this.response.end();\n    }, {\n      name: 'rss_posts_new',\n      where: 'server'\n    });\n\n    // Top Post RSS\n\n    Router.route('/rss/posts/top.xml', function () {\n      this.response.write(servePostRSS('top', 'rss/posts/top.xml'));\n      this.response.end();\n    }, {\n      name: 'rss_posts_top',\n      where: 'server'\n    });\n\n    // Best Post RSS\n\n    Router.route('/rss/posts/best.xml', function () {\n      this.response.write(servePostRSS('best', 'rss/posts/best.xml'));\n      this.response.end();\n    }, {\n      name: 'rss_posts_best',\n      where: 'server'\n    });\n\n    // Comment RSS\n\n    Router.route('/rss/comments.xml', function() {\n      this.response.write(serveCommentRSS());\n      this.response.end();\n    }, {\n      name: 'rss_comments',\n      where: 'server'\n    });\n\n});\n"]}