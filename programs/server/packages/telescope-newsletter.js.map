{"version":3,"sources":["telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/package-tap.i18n","telescope-newsletter/lib/newsletter.js","telescope-newsletter/lib/server/campaign.js","telescope-newsletter/lib/server/cron.js","telescope-newsletter/lib/server/mailchimp.js","telescope-newsletter/lib/server/routes.js","telescope-newsletter/lib/server/templates/emailDigest.handlebars","telescope-newsletter/lib/server/templates/emailDigestConfirmation.handlebars","telescope-newsletter/lib/server/templates/emailPostItem.handlebars","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/de.i18n.json","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/en.i18n.json","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/es.i18n.json","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/fr.i18n.json","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/it.i18n.json","telescope-newsletter//home/action/workspace/Telescope/packages/telescope-newsletter/i18n/zh-CN.i18n.json"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,sH;;AAEA,+D;AACA,gD;;;;;;;;;;;;;;;;;;;ACHA,mC;AACA,O;AACA,iB;AACA,kB;AACA,I;AACA,c;AACA,e;AACA,kB;AACA,I;AACA,W;AACA,iB;AACA,kB;AACA,I;AACA,W;AACA,iB;AACA,kB;AACA,I;AACA,U;AACA,mB;AACA,kB;AACA,I;AACA,Y;AACA,iB;AACA,kB;AACA,I;AACA,G;;AAEA,gD;AACA,wB;AACA,G;;AAEA,qB;AACA,G;AACA,gC;AACA,qB;AACA,iB;AACA,qB;AACA,iB;AACA,kB;AACA,O;AACA,K;AACA,G;AACA,E;;AAEA,W;;AAEA,wB;AACA,mC;AACA,mB;AACA,kB;AACA,mB;AACA,e;AACA,0B;AACA,2D;AACA,K;AACA,G;AACA,C;AACA,2C;;AAEA,kB;AACA,6B;AACA,mB;AACA,kB;AACA,mB;AACA,+B;AACA,e;AACA,0B;AACA,qE;AACA,K;AACA,G;AACA,C;AACA,qC;;AAEA,uB;AACA,kC;AACA,mB;AACA,iB;AACA,mB;AACA,e;AACA,0B;AACA,mB;AACA,K;AACA,G;AACA,C;AACA,0C;;AAEA,uB;AACA,kC;AACA,mB;AACA,iB;AACA,mB;AACA,e;AACA,0B;AACA,8D;AACA,mB;AACA,K;AACA,G;AACA,C;AACA,0C;;AAEA,0B;AACA,qC;AACA,mB;AACA,iB;AACA,mB;AACA,e;AACA,yB;AACA,K;AACA,G;AACA,C;AACA,6C;;AAEA,2B;AACA,sC;AACA,mB;AACA,iB;AACA,mB;AACA,e;AACA,0B;AACA,mG;AACA,gB;AACA,S;AACA,mB;AACA,4B;AACA,U;AACA,S;AACA,mB;AACA,+C;AACA,U;AACA,S;AACA,mB;AACA,sC;AACA,U;AACA,S;AACA,mB;AACA,wC;AACA,S;AACA,O;AACA,K;AACA,G;AACA,C;AACA,8C;;AAEA,sB;AACA,iC;AACA,mB;AACA,iB;AACA,mB;AACA,0B;AACA,e;AACA,0B;AACA,0F;AACA,kB;AACA,K;AACA,G;AACA,C;AACA,yC;;AAEA,qB;AACA,gC;AACA,mB;AACA,kB;AACA,mB;AACA,e;AACA,0B;AACA,mE;AACA,K;AACA,G;AACA,C;AACA,wC;;AAEA,gG;AACA,4C;AACA,U;AACA,W;AACA,oC;AACA,iB;AACA,yB;AACA,O;AACA,M;AACA,4C;AACA,I;AACA,C;;AAEA,kB;AACA,8B;AACA,G;;AAEA,0C;AACA,0D;AACA,8D;AACA,wB;AACA,yB;AACA,O;AACA,G;AACA,c;AACA,C;AACA,mD;;;;;;;;;;;;;;;;;;;ACrMA,qB;AACA,iB;;AAEA,0C;;AAEA,gF;;AAEA,qD;AACA,uH;AACA,E;AACA,yF;AACA,uD;AACA,uF;;AAEA,mC;AACA,qB;AACA,sB;AACA,gB;AACA,K;AACA,yD;AACA,C;;AAEA,uC;AACA,mC;;AAEA,iF;AACA,6C;AACA,iB;AACA,sB;;AAEA,0B;;AAEA,qD;;AAEA,qG;AACA,qC;AACA,sC;AACA,kC;AACA,0C;AACA,yC;AACA,uD;AACA,O;;AAEA,kB;AACA,iH;AACA,I;AACA,gB;AACA,6C;;AAEA,+D;AACA,K;;AAEA,0C;AACA,oD;AACA,kC;AACA,gD;AACA,sB;AACA,K;;AAEA,kD;AACA,iD;;AAEA,U;AACA,wC;AACA,oC;AACA,mB;AACA,G;AACA,C;;AAEA,0C;AACA,8D;AACA,+E;AACA,qB;AACA,0D;AACA,Q;AACA,+C;AACA,iB;AACA,G;AACA,C;;AAEA,gB;AACA,6B;AACA,gC;AACA,wC;AACA,G;AACA,G;;;;;;;;;;;;;;;;;;;ACrFA,sB;AACA,a;AACA,gC;AACA,a;AACA,uB;AACA,C;;AAEA,oC;AACA,sB;;AAEA,qC;AACA,sE;AACA,6B;AACA,e;AACA,sB;AACA,wB;AACA,sD;AACA,qD;;AAEA,2C;AACA,8C;AACA,6C;;AAEA,iC;AACA,4C;AACA,2C;;AAEA,oC;AACA,0C;AACA,yC;;AAEA,qC;AACA,yC;AACA,G;AACA,uE;AACA,C;;AAEA,gB;AACA,2B;AACA,uE;AACA,yB;AACA,mB;AACA,G;AACA,G;;AAEA,0B;AACA,kB;AACA,+B;AACA,gC;AACA,uC;AACA,iC;AACA,M;AACA,qB;AACA,6B;AACA,K;AACA,K;AACA,C;AACA,4B;AACA,8C;AACA,a;AACA,G;AACA,G;;;;;;;;;;;;;;;;;;AC7DA,6C;;AAEA,gD;AACA,8D;;AAEA,6C;AACA,6C;;AAEA,2B;;AAEA,S;;AAEA,sC;AACA,uE;AACA,oD;AACA,6B;AACA,wB;AACA,kB;AACA,0B;AACA,oC;AACA,mC;AACA,uD;AACA,U;AACA,kB;AACA,8B;AACA,oB;AACA,S;AACA,Q;;AAEA,4C;;AAEA,wB;AACA,uE;AACA,M;AACA,0C;AACA,8B;;AAEA,yF;;AAEA,6B;AACA,yB;AACA,oC;AACA,Q;;AAEA,0B;AACA,wE;AACA,M;AACA,8D;AACA,8B;;AAEA,kD;AACA,kB;AACA,sG;;AAEA,gC;AACA,0E;AACA,4B;AACA,6C;AACA,iC;AACA,S;AACA,4F;;AAEA,qB;AACA,yB;AACA,K;AACA,4B;AACA,G;AACA,C;;AAEA,0D;AACA,E;AACA,kB;;AAEA,gG;;AAEA,kF;AACA,uC;AACA,gB;AACA,wB;AACA,8C;AACA,uB;AACA,2B;AACA,e;AACA,8C;AACA,G;;AAEA,6C;AACA,6C;;AAEA,oC;AACA,qF;AACA,2B;;AAEA,S;;AAEA,8D;;AAEA,sC;AACA,8B;AACA,mB;AACA,gC;AACA,6B;AACA,Q;;AAEA,uB;AACA,uE;;AAEA,gC;AACA,gB;AACA,6D;;AAEA,wC;AACA,M;AACA,uB;;AAEA,qB;AACA,mE;AACA,mC;AACA,K;AACA,G;AACA,E;;AAEA,gB;AACA,4C;AACA,wD;AACA,S;AACA,oD;AACA,qB;AACA,iD;AACA,K;AACA,I;AACA,6C;AACA,S;AACA,6C;AACA,qB;AACA,iD;AACA,K;AACA,G;AACA,G;;;;;;;;;;;;;;;;;;AC1IA,4B;;AAEA,mC;AACA,qB;AACA,oB;AACA,wB;AACA,0F;AACA,+I;AACA,oI;;AAEA,0E;AACA,0B;AACA,K;AACA,K;;AAEA,8C;AACA,+B;AACA,oB;AACA,wB;AACA,0E;AACA,kC;AACA,6C;AACA,6C;AACA,S;AACA,gE;AACA,0B;AACA,K;AACA,K;;AAEA,G;;;;;;;;;;;;;;;;;;AC7BA,mmC;;;;;;;;;;;;;;;;;;ACAA,oe;;;;;;;;;;;;;;;;;;ACAA,krC;;;;;;;;;;;;;;;;;;ACAA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,iO;;;;;;;;;;;;;;;;;;;ACfA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,gD;AACA,iiB;;;;;;;;;;;;;;;;;;;ACRA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,iO;;;;;;;;;;;;;;;;;;;ACfA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,2c;;;;;;;;;;;;;;;;;;;ACfA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,iO;;;;;;;;;;;;;;;;;;;ACfA,6B;AACA,0C;AACA,uC;;AAEA,gC;AACA,yD;AACA,C;AACA,kD;AACA,qC;AACA,C;;AAEA,6D;AACA,gD;AACA,C;;AAEA,oO","file":"/packages/telescope-newsletter.js","sourcesContent":["TAPi18n.packages[\"telescope-newsletter\"] = {\"translation_function_name\":\"__\",\"helper_name\":\"_\",\"namespace\":\"project\"};\n\n// define package's translation function (proxy to the i18next)\n__ = TAPi18n._getPackageI18nextProxy(\"project\");\n","campaignSchema = new SimpleSchema({\n _id: {\n    type: String,\n    optional: true\n  },\n  createdAt: {\n    type: Date,\n    optional: true\n  },\n  sentAt: {\n    type: String,\n    optional: true\n  },\n  status: {\n    type: String,\n    optional: true\n  },\n  posts: {\n    type: [String],\n    optional: true\n  },\n  webHits: {\n    type: Number,\n    optional: true\n  },\n});\n\nCampaigns = new Meteor.Collection(\"campaigns\", {\n  schema: campaignSchema\n});\n\naddToPostSchema.push(\n  {\n    propertyName: 'scheduledAt',\n    propertySchema: {\n      type: Date,\n      optional: true,\n      autoform: {\n        omit: true\n      }\n    }\n  }\n);\n\n// Settings\n\nvar enableNewsletter = {\n  propertyName: 'enableNewsletter',\n  propertySchema: {\n    type: Boolean,\n    optional: true,\n    autoform: {\n      group: 'newsletter',\n      instructions: 'Enable newsletter (requires restart).'\n    }\n  }\n}\naddToSettingsSchema.push(enableNewsletter);\n\nvar showBanner = {\n  propertyName: 'showBanner',\n  propertySchema: {\n    type: Boolean,\n    optional: true,\n    label: 'Newsletter banner',\n    autoform: {\n      group: 'newsletter',\n      instructions: 'Show newsletter sign-up form on the front page.'\n    }\n  }\n}\naddToSettingsSchema.push(showBanner);\n\nvar mailChimpAPIKey = {\n  propertyName: 'mailChimpAPIKey',\n  propertySchema: {\n    type: String,\n    optional: true,\n    autoform: {\n      group: 'newsletter',\n      private: true\n    }\n  }\n}\naddToSettingsSchema.push(mailChimpAPIKey);\n\nvar mailChimpListId = {\n  propertyName: 'mailChimpListId',\n  propertySchema: {\n    type: String,\n    optional: true,\n    autoform: {\n      group: 'newsletter',\n      instructions: 'The ID of the list you want to send to.',\n      private: true\n    }\n  }\n}\naddToSettingsSchema.push(mailChimpListId);\n\nvar postsPerNewsletter = {\n  propertyName: 'postsPerNewsletter',\n  propertySchema: {\n    type: Number,\n    optional: true,\n    autoform: {\n      group: 'newsletter'\n    }\n  }\n}\naddToSettingsSchema.push(postsPerNewsletter);\n\nvar newsletterFrequency = {\n  propertyName: 'newsletterFrequency',\n  propertySchema: {\n    type: Number,\n    optional: true,\n    autoform: {\n      group: 'newsletter',\n      instructions: 'Defaults to once a week. Changes require restarting your app to take effect.',\n      options: [\n        {\n          value: 1,\n          label: 'Every Day'\n        },\n        {\n          value: 2,\n          label: 'Mondays, Wednesdays, Fridays'\n        },\n        {\n          value: 3,\n          label: 'Mondays & Thursdays'\n        },\n        {\n          value: 7,\n          label: 'Once a week (Mondays)'\n        }\n      ]\n    }\n  }\n}\naddToSettingsSchema.push(newsletterFrequency);\n\nvar newsletterTime = {\n  propertyName: 'newsletterTime',\n  propertySchema: {\n    type: String,\n    optional: true,\n    defaultValue: '00:00',\n    autoform: {\n      group: 'newsletter',\n      instructions: 'Defaults to 00:00/12:00 AM. Time to send out newsletter if enabled.',\n      type: 'time'\n    }\n  }\n}\naddToSettingsSchema.push(newsletterTime);\n\nvar autoSubscribe = {\n  propertyName: 'autoSubscribe',\n  propertySchema: {\n    type: Boolean,\n    optional: true,\n    autoform: {\n      group: 'newsletter',\n      instructions: 'Automatically subscribe new users on sign-up.'\n    }\n  }\n}\naddToSettingsSchema.push(autoSubscribe);\n\n// create new \"campaign\" lens for all posts from the past X days that haven't been scheduled yet\nviewParameters.campaign = function (terms) {\n  return {\n    find: {\n      scheduledAt: {$exists: false},\n      postedAt: {\n        $gte: terms.after\n      }\n    },\n    options: {sort: {sticky: -1, score: -1}}\n  };\n}\n\nheroModules.push({\n  template: 'newsletterBanner'\n});\n\n function subscribeUserOnCreation (user) {\n  if (!!getSetting('autoSubscribe') && !!getEmail(user)) {\n    addToMailChimpList(user, false, function (error, result) {\n      console.log(error)\n      console.log(result)\n    });\n  }\n  return user;\n}\nuserCreatedCallbacks.push(subscribeUserOnCreation);\n","defaultFrequency = 7;\ndefaultPosts = 5;\n\ngetCampaignPosts = function (postsCount) {\n\n  var newsletterFrequency = getSetting('newsletterFrequency', defaultFrequency);\n\n  // look for last scheduled campaign in the database\n  var lastCampaign = SyncedCron._collection.findOne({name: 'Schedule newsletter'}, {sort: {finishedAt: -1}, limit: 1});\n  \n  // if there is a last campaign use its date, else default to posts from the last 7 days\n  var lastWeek = moment().subtract(7, 'days').toDate();\n  var after = (typeof lastCampaign != 'undefined') ? lastCampaign.finishedAt : lastWeek\n\n  var params = getPostsParameters({\n    view: 'campaign',\n    limit: postsCount,\n    after: after\n  });\n  return Posts.find(params.find, params.options).fetch();\n}\n\nbuildCampaign = function (postsArray) {\n  var postsHTML = '', subject = '';\n\n  // 1. Iterate through posts and pass each of them through a handlebars template\n  postsArray.forEach(function (post, index) {\n    if(index > 0)\n      subject += ', ';\n\n    subject += post.title;\n\n    var postUser = Meteor.users.findOne(post.userId);\n\n    // the naked post object as stored in the database is missing a few properties, so let's add them\n    var properties = _.extend(post, {\n      authorName: getAuthorName(post),\n      postLink: getPostLink(post),\n      profileUrl: getProfileUrl(postUser),\n      postPageLink: getPostPageUrl(post),\n      date: moment(post.postedAt).format(\"MMMM D YYYY\")\n    });\n\n    if (post.body)\n      properties.body = marked(trimWords(post.body, 20)).replace('<p>', '').replace('</p>', ''); // remove p tags\n    \n    if(post.url)\n      properties.domain = getDomain(post.url)\n\n    postsHTML += getEmailTemplate('emailPostItem')(properties);\n  });\n\n  // 2. Wrap posts HTML in digest template\n  var digestHTML = getEmailTemplate('emailDigest')({\n    siteName: getSetting('title'),\n    date: moment().format(\"dddd, MMMM Do YYYY\"),\n    content: postsHTML\n  });\n\n  // 3. wrap digest HTML in email wrapper tempalte\n  var emailHTML = buildEmailTemplate(digestHTML);\n\n  return {\n    postIds: _.pluck(postsArray, '_id'),\n    subject: trimWords(subject, 15),\n    html: emailHTML\n  }\n}\n\nscheduleNextCampaign = function (isTest) {\n  var isTest = typeof isTest === 'undefined' ? false : isTest;\n  var posts = getCampaignPosts(getSetting('postsPerNewsletter', defaultPosts));\n  if(!!posts.length){\n    return scheduleCampaign(buildCampaign(posts), isTest);\n  }else{\n    var result = 'No posts to schedule today…';\n    return result\n  }\n}\n\nMeteor.methods({\n  testCampaign: function () {\n    if(isAdminById(this.userId))\n      return scheduleNextCampaign(true);\n  }\n});\n","SyncedCron.options = {\n  log: false,\n  collectionName: 'cronHistory',\n  utc: false,\n  collectionTTL: 172800\n}\n\ndefaultFrequency = 7; // once a week\ndefaultTime = '00:00';\n\nvar getSchedule = function (parser) {\n  var frequency = getSetting('newsletterFrequency', defaultFrequency);\n  var recur = parser.recur();\n  var schedule;\n  switch (frequency) {\n    case 1: // every day\n      // sched = {schedules: [{dw: [1,2,3,4,5,6,0]}]};\n      schedule = recur.on(1,2,3,4,5,6,0).dayOfWeek();\n\n    case 2: // Mondays, Wednesdays, Fridays\n      // sched = {schedules: [{dw: [2,4,6]}]};\n      schedule = recur.on(2,4,6).dayOfWeek();\n\n    case 3: // Mondays, Thursdays\n      // sched = {schedules: [{dw: [2,5]}]};\n      schedule = recur.on(2,5).dayOfWeek();\n\n    case 7: // Once a week (Mondays)\n      // sched = {schedules: [{dw: [2]}]};\n      schedule = recur.on(2).dayOfWeek();\n\n    default: // Once a week (Mondays)\n      schedule = recur.on(2).dayOfWeek();\n  }\n  return schedule.on(getSetting('newsletterTime', defaultTime)).time();\n}\n\nMeteor.methods({\n  getNextJob: function () {\n    var nextJob = SyncedCron.nextScheduledAtDate('scheduleNewsletter');\n    console.log(nextJob);\n    return nextJob;\n  }\n});\n\nvar addJob = function () {\n  SyncedCron.add({\n    name: 'scheduleNewsletter',\n    schedule: function(parser) {\n      // parser is a later.parse object\n      return getSchedule(parser);\n    },\n    job: function() {\n      scheduleNextCampaign();\n    }\n  });\n}\nMeteor.startup(function () {\n  if (getSetting('enableNewsletter', false)) {\n    addJob();\n  }\n});","var htmlToText = Npm.require('html-to-text');\n\nscheduleCampaign = function (campaign, isTest) {\n  var isTest = typeof isTest === 'undefined' ? false : isTest;\n\n  var apiKey = getSetting('mailChimpAPIKey');\n  var listId = getSetting('mailChimpListId');\n\n  if(!!apiKey && !!listId){\n\n    try {\n\n      var api = new MailChimp(apiKey);\n      var text = htmlToText.fromString(campaign.html, {wordwrap: 130});\n      var defaultEmail = getSetting('defaultEmail');\n      var campaignOptions = {\n        type: 'regular',\n        options: {\n          list_id: listId,\n          subject: campaign.subject,\n          from_email: defaultEmail,\n          from_name: getSetting('title')+ ' Top Posts',\n        },\n        content: {\n          html: campaign.html,\n          text: text\n        }\n      };\n\n      console.log( '// Creating campaign…');\n\n      // create campaign\n      var campaign = api.call( 'campaigns', 'create', campaignOptions);\n      \n      console.log( '// Campaign created');\n      // console.log(campaign)\n\n      var scheduledTime = moment().zone(0).add(1, 'hours').format(\"YYYY-MM-DD HH:mm:ss\");\n\n      var scheduleOptions = {\n        cid: campaign.id,\n        schedule_time: scheduledTime\n      };\n\n      // schedule campaign\n      var schedule = api.call('campaigns', 'schedule', scheduleOptions);\n      \n      console.log('// Campaign scheduled for '+scheduledTime);\n      // console.log(schedule)\n\n      // if this is not a test, mark posts as sent\n      if (!isTest)\n        Posts.update({_id: {$in: campaign.postIds}}, {$set: {scheduledAt: new Date()}}, {multi: true})\n\n      // send confirmation email\n      var confirmationHtml = getEmailTemplate('emailDigestConfirmation')({\n        time: scheduledTime,\n        newsletterLink: campaign.archive_url,\n        subject: campaign.subject\n      });\n      sendEmail(defaultEmail, 'Newsletter scheduled', buildEmailTemplate(confirmationHtml));\n\n    } catch (error) {\n      console.log(error);\n    }\n    return campaign.subject;\n  }\n}\n\naddToMailChimpList = function(userOrEmail, confirm, done){\n  \n  var user, email;\n\n  var confirm = (typeof confirm === 'undefined') ? false : confirm // default to no confirmation\n\n  // not sure if it's really necessary that the function take both user and email?\n  if (typeof userOrEmail == \"string\") {\n    user = null;\n    email = userOrEmail;\n  } else if (typeof userOrEmail == \"object\") {\n    user = userOrEmail;\n    email = getEmail(user);\n    if (!email)\n      throw 'User must have an email address';\n  }\n\n  var apiKey = getSetting('mailChimpAPIKey');\n  var listId = getSetting('mailChimpListId');\n\n  // add a user to a MailChimp list.\n  // called when a new user is created, or when an existing user fills in their email\n  if(!!apiKey && !!listId){\n\n    try {\n\n      console.log('// Adding \"'+email+'\" to MailChimp list…');\n\n      var api = new MailChimp(apiKey);\n      var subscribeOptions = {\n        id: listId,\n        email: {\"email\": email},\n        double_optin: confirm\n      };\n\n      // subscribe user\n      var subscribe = api.call('lists', 'subscribe', subscribeOptions);\n\n      // mark user as subscribed\n      if(!!user)\n        setUserSetting('subscribedToNewsletter', true, user);\n\n      console.log(\"// User subscribed\");\n      \n      return subscribe;\n\n    } catch (error) {\n      throw new Meteor.Error(\"subscription-failed\", error.message);\n      console.log( error.message );\n    }\n  }\n};\n\nMeteor.methods({\n  addCurrentUserToMailChimpList: function(){\n    var currentUser = Meteor.users.findOne(this.userId);\n    try {\n      return addToMailChimpList(currentUser, false);\n    } catch (error) {\n      throw new Meteor.Error(500, error.message);\n    }\n  },\n  addEmailToMailChimpList: function (email) {\n    try {\n      return addToMailChimpList(email, true);\n    } catch (error) {\n      throw new Meteor.Error(500, error.message);\n    }\n  }\n});","Meteor.startup(function () {\n\n  Router.route('/email/campaign', {\n    name: 'campaign',\n    where: 'server',\n    action: function() {\n      var campaign = buildCampaign(getCampaignPosts(getSetting('postsPerNewsletter', 5)));\n      var campaignSubject = '<div class=\"campaign-subject\"><strong>Subject:</strong> '+campaign.subject+' (note: contents might change)</div>';\n      var campaignSchedule = '<div class=\"campaign-schedule\"><strong>Scheduled for:</strong> '+ Meteor.call('getNextJob') +'</div>';\n\n      this.response.write(campaignSubject+campaignSchedule+campaign.html);\n      this.response.end();\n    }\n  });\n\n  Router.route('/email/digest-confirmation', {\n    name: 'digestConfirmation',\n    where: 'server',\n    action: function() {\n      var confirmationHtml = getEmailTemplate('emailDigestConfirmation')({\n        time: 'January 1st, 1901',\n        newsletterLink: 'http://example.com',\n        subject: 'Lorem ipsum dolor sit amet'\n      });\n      this.response.write(buildEmailTemplate(confirmationHtml));\n      this.response.end();\n    }\n  });\n\n});","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<style type=\\\"text/css\\\">\\n  .email-digest{\\n  }\\n  .digest-date{\\n    color: #999;\\n    font-weight: normal;\\n    font-size: 16px;\\n  }\\n  .post-item{\\n    border-top: 1px solid #ddd;\\n  }\\n  .post-date{\\n    font-size: 13px;\\n    color: #999;\\n  }\\n  .post-title{\\n    font-size: 18px;\\n    line-height: 1.6;\\n  }\\n  .post-thumbnail{\\n  }\\n  .post-meta{\\n    font-size: 13px;\\n    color: #999;\\n    margin: 5px 0;\\n  }\\n  .post-meta a{\\n    color: #333;\\n  }  \\n  .post-domain{\\n    font-weight: bold;\\n  }\\n  .post-body-excerpt{\\n    font-size: 14px;\\n  }\\n  .post-body-excerpt p{\\n    margin: 0;\\n  }\\n</style>\\n\\n<span class=\\\"heading\\\">Recently on {{siteName}}</span>\\n<span class=\\\"digest-date\\\">– {{date}}</span>\\n<br><br>\\n\\n<div class=\\\"email-digest\\\">\\n  {{{content}}}\\n</div>\\n<br>\");Handlebars.templates[\"emailDigest\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailDigest\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">Newsletter scheduled for {{time}}</span><br><br>\\n\\n<a href=\\\"{{newsletterLink}}\\\">{{subject}}</a><br><br>\");Handlebars.templates[\"emailDigestConfirmation\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailDigestConfirmation\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<div class=\\\"post-item\\\">\\n<br >\\n\\n<span class=\\\"post-title\\\">\\n  {{#if thumbnailUrl}}\\n    <img class=\\\"post-thumbnail\\\" src=\\\"{{thumbnailUrl}}\\\"/>&nbsp;\\n  {{/if}}\\n\\n  <a href=\\\"{{postLink}}\\\" target=\\\"_blank\\\">{{title}}</a>\\n</span>\\n\\n<div class=\\\"post-meta\\\">\\n  {{#if domain}}\\n    <a class=\\\"post-domain\\\" href=\\\"\\\">{{domain}}</a>\\n    | \\n  {{/if}}\\n  <span class=\\\"post-submitted\\\">Submitted by <a href=\\\"{{profileUrl}}\\\" class=\\\"comment-link\\\" target=\\\"_blank\\\">{{authorName}}</a></span>\\n  <span class=\\\"post-date\\\">on {{date}}</span>\\n  |\\n  <a href=\\\"{{postPageLink}}\\\" class=\\\"comment-link\\\" target=\\\"_blank\\\">{{commentCount}} Comments</a>\\n</div>\\n\\n\\n{{#if body}}\\n  <div class=\\\"post-body-excerpt\\\">\\n    {{{htmlBody}}}\\n    <a href=\\\"{{postPageLink}}\\\" class=\\\"comment-link\\\" target=\\\"_blank\\\">Read more</a>\\n  </div>\\n{{/if}}\\n\\n\\n<br>\\n</div>\\n\\n\");Handlebars.templates[\"emailPostItem\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailPostItem\"});};","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nif(_.isUndefined(TAPi18n.translations[\"de\"])) {\n  TAPi18n.translations[\"de\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"de\"][namespace])) {\n  TAPi18n.translations[\"de\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"de\"][namespace], {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\"});\n","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\n// integrate the fallback language translations \nTAPi18n.addResourceBundle(\"en\", namespace, {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\",\"newsletter\":\"newsletter\",\"showBanner\":\"Show Banner\",\"mailChimpAPIKey\":\"MailChimp API Key\",\"mailChimpListId\":\"MailChimp List ID\",\"postsPerNewsletter\":\"Posts per Newsletter\",\"newsletterFrequency\":\"Newsletter Frequency\",\"newsletterTime\":\"Newsletter Time\",\"enableNewsletter\":\"Enable Newsletter\",\"autoSubscribe\":\"Auto Subscribe\"});\n","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nif(_.isUndefined(TAPi18n.translations[\"es\"])) {\n  TAPi18n.translations[\"es\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"es\"][namespace])) {\n  TAPi18n.translations[\"es\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"es\"][namespace], {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\"});\n","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nif(_.isUndefined(TAPi18n.translations[\"fr\"])) {\n  TAPi18n.translations[\"fr\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"fr\"][namespace])) {\n  TAPi18n.translations[\"fr\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"fr\"][namespace], {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\",\"newsletter\":\"newsletter\",\"showBanner\":\"Afficher la Bannière\",\"mailChimpAPIKey\":\"Clé API MailChimp\",\"mailChimpListId\":\"ID Liste MailChimp\",\"postsPerNewsletter\":\"Posts par Newsletter\",\"newsletterFrequency\":\"Fréquence de la Newsletter\"});\n","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nif(_.isUndefined(TAPi18n.translations[\"it\"])) {\n  TAPi18n.translations[\"it\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"it\"][namespace])) {\n  TAPi18n.translations[\"it\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"it\"][namespace], {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\"});\n","var _ = Package.underscore._,\n    package_name = \"telescope-newsletter\",\n    namespace = \"telescope-newsletter\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nif(_.isUndefined(TAPi18n.translations[\"zh-CN\"])) {\n  TAPi18n.translations[\"zh-CN\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"zh-CN\"][namespace])) {\n  TAPi18n.translations[\"zh-CN\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"zh-CN\"][namespace], {\"receive_the_best_of\":\"Receive the best of\",\"right_in_your_inbox\":\"right in your inbox.\",\"get_newsletter\":\"Get Newsletter\",\"thanks_for_subscribing\":\"Thanks for subscribing!\"});\n"]}